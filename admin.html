<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mr. å¥½å¥½ - è¨‚å–®ç®¡ç†å¾Œå°</title>
    <style>
        :root {
            --bg-color: #ecf0f5;
            --card-bg: #ffffff;
            --main-green: #165b33;
            --main-red: #d63030;
            --gold: #d4af37;
            --text: #333;
        }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; color: var(--text); }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* ç™»å…¥é®ç½© */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--main-green); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-box { background: white; padding: 30px; border-radius: 10px; text-align: center; width: 300px;}
        .login-box input { width: 100%; padding: 10px; margin: 10px 0; font-size: 16px; box-sizing: border-box;}
        .login-box button { width: 100%; padding: 10px; background: var(--main-red); color: white; border: none; cursor: pointer; font-size: 16px; border-radius: 5px;}

        h1 { text-align: center; color: var(--main-green); margin-bottom: 20px; }

        /* çµ±è¨ˆå„€è¡¨æ¿ */
        .dashboard-stats { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;}
        .stat-card { flex: 1; background: var(--card-bg); padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; min-width: 200px; border-top: 4px solid var(--gold); }
        .stat-number { font-size: 32px; font-weight: bold; color: var(--main-red); margin: 10px 0; }
        .stat-label { color: #666; font-size: 14px; }

        /* åˆ‡æ›æ¨™ç±¤ */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .tab-btn { padding: 10px 25px; border: none; background: #ddd; cursor: pointer; border-radius: 20px; font-weight: bold; font-size: 16px; }
        .tab-btn.active { background: var(--main-green); color: white; }

        /* å…§å®¹å€åŸŸ */
        .view-section { display: none; }
        .view-section.active { display: block; }

        /* 1. è¨‚å–®åˆ—è¡¨è¦–åœ– */
        .order-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .order-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-left: 5px solid var(--main-green); position: relative; }
        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .card-ig { font-weight: bold; font-size: 18px; color: var(--main-green); }
        .card-pickup { background: #eee; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
        .card-items { font-size: 14px; line-height: 1.6; color: #555; background: #fafafa; padding: 10px; border-radius: 5px; }
        .card-footer { margin-top: 10px; display: flex; justify-content: space-between; font-weight: bold; align-items: center; }
        .card-price { color: var(--main-red); font-size: 20px; }
        .card-phone { font-size: 12px; color: #999; }
        .card-time { font-size: 12px; color: #ccc; position: absolute; top: 10px; right: 10px; display: none;} /* éš±è—æ™‚é–“ä¿æŒç°¡æ½” */

        /* 2. è£½ä½œçµ±è¨ˆè¡¨æ ¼ */
        .production-table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .production-table th, .production-table td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        .production-table th { background-color: var(--main-green); color: white; }
        .production-table tr:last-child td { border-bottom: none; }
        .qty-highlight { font-weight: bold; color: var(--main-red); font-size: 18px; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2 style="color: #165b33;">å•†å®¶å¾Œå°ç™»å…¥</h2>
        <input type="password" id="passwordInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
        <button onclick="checkLogin()">ç™»å…¥</button>
        <p id="errorMsg" style="color:red; display:none; margin-top:10px;">å¯†ç¢¼éŒ¯èª¤</p>
    </div>
</div>

<div class="container" id="main-content" style="display:none;">
    <h1>ğŸ„ è¨‚å–®ç®¡ç†å„€è¡¨æ¿</h1>

    <div class="dashboard-stats">
        <div class="stat-card">
            <div class="stat-label">ç¸½è¨‚å–®æ•¸</div>
            <div class="stat-number" id="totalOrders">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ç¸½ç‡Ÿæ¥­é¡</div>
            <div class="stat-number" id="totalRevenue">$0</div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('list')">ğŸ“‹ è¨‚å–®æª¢è¦–</button>
        <button class="tab-btn" onclick="switchTab('production')">ğŸ° è£½ä½œçµ±è¨ˆ</button>
    </div>

    <div id="view-list" class="view-section active">
        <div id="loading" style="text-align:center; color:#666;">è³‡æ–™è®€å–ä¸­...</div>
        <div class="order-list" id="orderContainer"></div>
    </div>

    <div id="view-production" class="view-section">
        <table class="production-table">
            <thead>
                <tr>
                    <th>ç”¢å“åç¨±</th>
                    <th>ç¸½æ•¸é‡</th>
                </tr>
            </thead>
            <tbody id="productionBody">
                </tbody>
        </table>
    </div>
</div>

<script>
    // ==========================================
    // âš ï¸ è«‹æ›æˆæ‚¨å‰›å‰›ã€Œé‡æ–°éƒ¨ç½²ã€å¾Œçš„ Apps Script ç¶²å€
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwsivpORW1vi3zrac7T9qMuRfiSGkwRIRKasqy2GXDsZuGnx4MdEOFWtdWUP1RwRRVH/exec"; 
    // ==========================================

    const PASSWORD = "1220"; // è¨­å®šå¾Œå°å¯†ç¢¼

    function checkLogin() {
        const input = document.getElementById('passwordInput').value;
        if (input === PASSWORD) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            fetchData(); // ç™»å…¥æˆåŠŸæ‰æŠ“è³‡æ–™
        } else {
            document.getElementById('errorMsg').style.display = 'block';
        }
    }

    // æŠ“å–è³‡æ–™
    function fetchData() {
        fetch(SCRIPT_URL)
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                renderDashboard(data);
            })
            .catch(err => {
                alert("è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²å€æ˜¯å¦æ­£ç¢º");
            });
    }

    function renderDashboard(orders) {
        // åè½‰è¨‚å–®ï¼Œè®“æœ€æ–°çš„é¡¯ç¤ºåœ¨æœ€ä¸Šé¢
        orders.reverse();

        const orderContainer = document.getElementById('orderContainer');
        const productionBody = document.getElementById('productionBody');
        
        let totalRev = 0;
        let productCounts = {};

        // æ¸…ç©ºå®¹å™¨
        orderContainer.innerHTML = '';
        productionBody.innerHTML = '';

        orders.forEach(order => {
            // 1. è¨ˆç®—ç¸½ç‡Ÿæ”¶
            // ç¢ºä¿ price æ˜¯æ•¸å­— (æœ‰äº›å¯èƒ½æ˜¯å­—ä¸²)
            let price = parseInt(order.price) || 0;
            totalRev += price;

            // 2. å»ºç«‹è¨‚å–®å¡ç‰‡
            // è™•ç†æ›è¡Œç¬¦è™Ÿï¼Œè®“å¡ç‰‡é¡¯ç¤ºæ¼‚äº®
            let detailsHtml = order.details.replace(/\n/g, '<br>');
            
            const card = document.createElement('div');
            card.className = 'order-card';
            card.innerHTML = `
                <div class="card-header">
                    <span class="card-ig">@${order.name}</span>
                    <span class="card-pickup">${order.pickup}</span>
                </div>
                <div class="card-items">${detailsHtml}</div>
                <div class="card-footer">
                    <span class="card-phone">ğŸ“ ${order.phone}</span>
                    <span class="card-price">$${price}</span>
                </div>
            `;
            orderContainer.appendChild(card);

            // 3. çµ±è¨ˆç”¢å“æ•¸é‡é‚è¼¯
            // è¨‚å–®å…§å®¹æ ¼å¼é€šå¸¸æ˜¯: "ç”¢å“å xæ•¸é‡"
            // æˆ‘å€‘ä¾æ›è¡Œæ‹†åˆ†
            let items = order.details.split('\n');
            items.forEach(item => {
                // ä½¿ç”¨ Regex åˆ†é›¢åç¨±å’Œæ•¸é‡
                // å‡è¨­æ ¼å¼ç‚º "è¿·ä½ æ©˜å­å„ªæ ¼å¡” x2"
                let parts = item.split(' x');
                if (parts.length === 2) {
                    let pName = parts[0].trim();
                    let pQty = parseInt(parts[1]) || 0;
                    
                    if (productCounts[pName]) {
                        productCounts[pName] += pQty;
                    } else {
                        productCounts[pName] = pQty;
                    }
                }
            });
        });

        // æ›´æ–°é ‚éƒ¨æ•¸å­—
        document.getElementById('totalOrders').innerText = orders.length;
        document.getElementById('totalRevenue').innerText = "$" + totalRev;

        // æ¸²æŸ“è£½ä½œçµ±è¨ˆè¡¨æ ¼
        // å°‡ç‰©ä»¶è½‰ç‚ºé™£åˆ—ä¸¦æ’åº (æ•¸é‡å¤šçš„æ’å‰é¢)
        let sortedProducts = Object.keys(productCounts).map(key => {
            return { name: key, count: productCounts[key] };
        }).sort((a, b) => b.count - a.count); // æ•¸é‡å¤§åˆ°å°æ’åº

        sortedProducts.forEach(p => {
            let row = `<tr>
                <td>${p.name}</td>
                <td class="qty-highlight">${p.count}</td>
            </tr>`;
            productionBody.innerHTML += row;
        });
    }

    function switchTab(tabName) {
        // åˆ‡æ›æŒ‰éˆ•æ¨£å¼
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        // åˆ‡æ›å…§å®¹é¡¯ç¤º
        document.querySelectorAll('.view-section').forEach(view => view.classList.remove('active'));
        document.getElementById('view-' + tabName).classList.add('active');
    }
</script>

</body>
</html>