<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mr. å¥½å¥½ - è¨‚å–®ç®¡ç†å¾Œå°</title>
    <style>
        :root {
            --bg-color: #ecf0f5;
            --card-bg: #ffffff;
            --main-green: #165b33;
            --main-red: #d63030;
            --gold: #d4af37;
            --text: #333;
        }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; color: var(--text); }
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* ç™»å…¥é®ç½© */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--main-green); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-box { background: white; padding: 30px; border-radius: 10px; text-align: center; width: 300px;}
        .login-box input { width: 100%; padding: 10px; margin: 10px 0; }
        .login-box button { width: 100%; padding: 10px; background: var(--main-red); color: white; border: none; cursor: pointer; border-radius: 5px;}

        h1 { text-align: center; color: var(--main-green); margin-bottom: 20px; }

        /* çµ±è¨ˆå„€è¡¨æ¿ (ç¾åœ¨åªæœ‰ç¸½è¨‚å–®æ•¸åœ¨é ‚éƒ¨) */
        .dashboard-stats { display: flex; gap: 20px; margin-bottom: 20px; justify-content: center;}
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; min-width: 200px; border-top: 4px solid var(--gold); }
        .stat-number { font-size: 32px; font-weight: bold; color: var(--main-green); margin: 10px 0; }
        .stat-label { color: #666; font-size: 14px; }
        .revenue-text { color: var(--main-red); }

        /* æ¨™ç±¤åˆ‡æ› */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .tab-btn { padding: 10px 25px; border: none; background: #ddd; cursor: pointer; border-radius: 20px; font-weight: bold; font-size: 16px; }
        .tab-btn.active { background: var(--main-green); color: white; }

        .view-section { display: none; }
        .view-section.active { display: block; }

        /* è¨‚å–®åˆ—è¡¨ */
        .order-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .order-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-left: 5px solid #ccc; position: relative; cursor: pointer; transition: transform 0.2s; }
        .order-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
        /* å·²ç¢ºèªçš„æ¨£å¼ */
        .order-card.confirmed { border-left: 5px solid var(--main-green); }
        .badge-confirmed { position: absolute; top: 10px; right: 10px; background: var(--main-green); color: white; font-size: 12px; padding: 3px 8px; border-radius: 10px; display: none; }
        .order-card.confirmed .badge-confirmed { display: block; }

        .card-header { font-weight: bold; font-size: 18px; color: #333; margin-bottom: 5px; }
        .card-pickup { background: #eee; padding: 2px 8px; border-radius: 4px; font-size: 12px; display: inline-block; margin-bottom: 10px;}
        .card-items { font-size: 14px; line-height: 1.6; color: #555; background: #fafafa; padding: 10px; border-radius: 5px; max-height: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        
        /* çµ±è¨ˆè¡¨æ ¼ */
        .production-table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 20px;}
        .production-table th, .production-table td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        .production-table th { background-color: var(--main-green); color: white; }
        .qty-highlight { font-weight: bold; color: var(--main-red); font-size: 18px; }

        /* --- è©³ç´°è¦–çª—èˆ‡ç·¨è¼¯ä»‹é¢ --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 90%; max-width: 600px; border-radius: 15px; padding: 25px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.3); position: relative;}
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #999; }
        
        .detail-row { margin-bottom: 15px; font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .detail-label { font-weight: bold; color: var(--main-green); display: block; margin-bottom: 5px; }
        .detail-content { color: #333; }
        .detail-list { background: #f9f9f9; padding: 15px; border-radius: 8px; }

        .action-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn-confirm { flex: 1; padding: 12px; background: var(--main-green); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-modify { flex: 1; padding: 12px; background: var(--gold); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-save { width: 100%; padding: 12px; background: var(--main-red); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px;}
        
        /* ç·¨è¼¯æ¨¡å¼ä¸‹çš„ç”¢å“åˆ—è¡¨ */
        .edit-product-list { display: grid; gap: 10px; margin-top: 10px; }
        .edit-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 5px; }
        .edit-item-name { font-weight: bold; font-size: 14px; }
        .edit-controls { display: flex; align-items: center; gap: 10px; }
        .edit-btn { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #ccc; background: white; cursor: pointer; }
        .edit-qty { width: 30px; text-align: center; border: none; font-weight: bold; }

    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2 style="color: #165b33;">å•†å®¶å¾Œå°ç™»å…¥</h2>
        <input type="password" id="passwordInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼ (1220)">
        <button onclick="checkLogin()">ç™»å…¥</button>
        <p id="errorMsg" style="color:red; display:none; margin-top:10px;">å¯†ç¢¼éŒ¯èª¤</p>
    </div>
</div>

<div class="container" id="main-content" style="display:none;">
    <h1>ğŸ„ è¨‚å–®ç®¡ç†å„€è¡¨æ¿</h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('list')">ğŸ“‹ è¨‚å–®æª¢è¦–</button>
        <button class="tab-btn" onclick="switchTab('production')">ğŸ° è£½ä½œçµ±è¨ˆ</button>
    </div>

    <div id="view-list" class="view-section active">
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-label">ç¸½è¨‚å–®æ•¸</div>
                <div class="stat-number" id="totalOrders">0</div>
            </div>
        </div>
        <div id="loading" style="text-align:center; color:#666; margin-top:20px;">è³‡æ–™è®€å–ä¸­...</div>
        <div class="order-list" id="orderContainer"></div>
    </div>

    <div id="view-production" class="view-section">
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-label">ç¸½ç‡Ÿæ¥­é¡</div>
                <div class="stat-number revenue-text" id="totalRevenue">$0</div>
            </div>
        </div>
        
        <table class="production-table">
            <thead><tr><th>ç”¢å“åç¨±</th><th>ç¸½æ•¸é‡</th></tr></thead>
            <tbody id="productionBody"></tbody>
        </table>
    </div>
</div>

<div class="modal-overlay" id="detailModal">
    <div class="modal-box">
        <span class="close-btn" onclick="closeDetailModal()">&times;</span>
        <h2 id="modalTitle" style="color:var(--main-green); text-align:center;">è¨‚å–®è©³æƒ…</h2>
        
        <div id="viewMode">
            <div class="detail-row">
                <span class="detail-label">è¨‚è³¼äºº IG / é›»è©±</span>
                <span class="detail-content" id="d-name"></span> / <span class="detail-content" id="d-phone"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">å–è²¨åœ°é»</span>
                <span class="detail-content" id="d-pickup"></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">ç›®å‰ç‹€æ…‹</span>
                <span class="detail-content" id="d-status" style="font-weight:bold;"></span>
            </div>
            <div class="detail-label">è¨‚è³¼å…§å®¹ï¼š</div>
            <div class="detail-list" id="d-list"></div>
            <div style="text-align:right; font-size:20px; font-weight:bold; color:var(--main-red); margin-top:10px;">
                ç¸½è¨ˆ: <span id="d-price"></span>
            </div>

            <div class="action-btns">
                <button id="btnConfirm" class="btn-confirm" onclick="confirmOrder()">âœ… ç¢ºèªè¨‚å–®</button>
                <button class="btn-modify" onclick="enableEditMode()">âœï¸ ä¿®æ”¹è¨‚å–®</button>
            </div>
        </div>

        <div id="editMode" style="display:none;">
            <h3 style="text-align:center; color:#666;">ä¿®æ”¹è¨‚è³¼å…§å®¹</h3>
            <div class="edit-product-list" id="editListContainer"></div>
            <div style="text-align:right; font-size:18px; font-weight:bold; margin-top:15px;">
                é ä¼°æ–°é‡‘é¡: $<span id="edit-total-price">0</span>
            </div>
            <button class="btn-save" id="btnSave" onclick="saveEditedOrder()">ğŸ’¾ å„²å­˜ä¿®æ”¹</button>
            <button style="width:100%; padding:10px; background:#ccc; border:none; border-radius:5px; margin-top:10px; cursor:pointer;" onclick="cancelEdit()">å–æ¶ˆä¿®æ”¹</button>
        </div>

    </div>
</div>

<script>
    // ==========================================
    // âš ï¸ è«‹æ›æˆæ‚¨æ–°éƒ¨ç½²çš„ Google Script ç¶²å€
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby7SG7jf-_xyCTqYCyg3aPS06CKvOjsq-G3PU_qbcN4H11yHz5jdBBBsnKmibw-bPYX/exec"; 
    // ==========================================

    // ç”¢å“è³‡æ–™ (å¿…é ˆè·Ÿ index.html ä¸€æ¨£)
    const products = [
        { id: 1, name: "è¿·ä½ æ©˜å­å„ªæ ¼å¡”", price: 70 },
        { id: 2, name: "è¿·ä½ é–‹å¿ƒä¹³é…ª", price: 70 },
        { id: 3, name: "è¿·ä½ é–‹å¿ƒè„†è„†", price: 70 },
        { id: 4, name: "è¿·ä½ å¸ƒæœ—å°¼", price: 25 },
        { id: 5, name: "è¿·ä½ ç¶ è‘¡è„å„ªæ ¼å¡”", price: 65 },
        { id: 6, name: "è¿·ä½ æ«»æ¡ƒå„ªæ ¼å¡”", price: 65 },
        { id: 7, name: "è¿·ä½ è—è“å„ªæ ¼å¡”", price: 65 },
        { id: 8, name: "è¿·ä½ è—è“å·§å·§å¡”", price: 65 },
        { id: 9, name: "è¿·ä½ æŠ¹èŒ¶ç”Ÿä¹³é…ª", price: 50 },
        { id: 10, name: "è¿·ä½ å·§å·§ç”Ÿä¹³é…ª", price: 50 },
        { id: 11, name: "è¿·ä½ è‰è“å„ªæ ¼å¡”", price: 65 },
        { id: 12, name: "è¿·ä½ è‰è“æŠ¹èŒ¶å¡”", price: 65 },
        { id: 13, name: "è¿·ä½ æŠ¹èŒ¶ä¹³é…ªå¸ƒæœ—å°¼", price: 45 },
        { id: 14, name: "è¿·ä½ å·§å·§ä¹³é…ªå¸ƒæœ—å°¼", price: 45 },
        { id: 15, name: "è¿·ä½ ç¶ è‘¡è„å„ªæ ¼å¸ƒæœ—å°¼", price: 45 },
        { id: 16, name: "è¿·ä½ è—è“å„ªæ ¼å¸ƒæœ—å°¼", price: 45 },
        { id: 17, name: "è¿·ä½ æª¸æª¬å¡”", price: 50 },
        { id: 18, name: "è¿·ä½ ç™¾é¦™æœå¡”", price: 50 },
        { id: 19, name: "è¿·ä½ æŸšå­ç”Ÿä¹³é…ªå¡”", price: 50 },
        { id: 20, name: "è¿·ä½ è§€éŸ³", price: 50 }
    ];

    const PASSWORD = "1220";
    let allOrders = []; // å­˜æ‰€æœ‰è¨‚å–®
    let currentOrder = null; // ç•¶å‰æ­£åœ¨çœ‹çš„è¨‚å–®
    let editCart = []; // ç·¨è¼¯æ¨¡å¼ä¸‹çš„è³¼ç‰©è»Š

    function checkLogin() {
        if (document.getElementById('passwordInput').value === PASSWORD) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            fetchData();
        } else {
            document.getElementById('errorMsg').style.display = 'block';
        }
    }

    function fetchData() {
        fetch(SCRIPT_URL)
            .then(res => res.json())
            .then(data => {
                allOrders = data.reverse(); // æœ€æ–°çš„åœ¨å‰é¢
                document.getElementById('loading').style.display = 'none';
                renderDashboard();
            })
            .catch(err => alert("è®€å–å¤±æ•—"));
    }

    function renderDashboard() {
        const orderContainer = document.getElementById('orderContainer');
        const productionBody = document.getElementById('productionBody');
        
        let totalRev = 0;
        let productCounts = {};

        orderContainer.innerHTML = '';
        productionBody.innerHTML = '';

        allOrders.forEach((order, index) => {
            let price = parseInt(order.price) || 0;
            totalRev += price;

            // è™•ç†ç‹€æ…‹æ¨£å¼
            let isConfirmed = order.status === "å·²ç¢ºèª";
            let cardClass = isConfirmed ? "order-card confirmed" : "order-card";
            let detailsHtml = order.details.replace(/\n/g, ', '); // åˆ—è¡¨ç¸®ç•¥é¡¯ç¤º

            const card = document.createElement('div');
            card.className = cardClass;
            // é»æ“Šå¡ç‰‡é–‹å•Ÿè©³ç´°è¦–çª—ï¼Œå‚³å…¥ index
            card.onclick = () => openDetailModal(index);
            
            card.innerHTML = `
                <div class="badge-confirmed">å·²ç¢ºèª</div>
                <div class="card-header">@${order.name}</div>
                <div class="card-pickup">${order.pickup}</div>
                <div class="card-items">${detailsHtml}</div>
                <div style="display:flex; justify-content:space-between; margin-top:10px; font-weight:bold;">
                    <span style="color:#999;">ğŸ“ ${order.phone}</span>
                    <span style="color:var(--main-red);">$${price}</span>
                </div>
            `;
            orderContainer.appendChild(card);

            // çµ±è¨ˆæ•¸é‡
            let items = order.details.split('\n');
            items.forEach(item => {
                let parts = item.split(' x');
                if (parts.length === 2) {
                    let pName = parts[0].trim();
                    let pQty = parseInt(parts[1]) || 0;
                    productCounts[pName] = (productCounts[pName] || 0) + pQty;
                }
            });
        });

        document.getElementById('totalOrders').innerText = allOrders.length;
        document.getElementById('totalRevenue').innerText = "$" + totalRev;

        // æ¸²æŸ“çµ±è¨ˆè¡¨
        Object.keys(productCounts)
            .sort((a, b) => productCounts[b] - productCounts[a])
            .forEach(name => {
                productionBody.innerHTML += `<tr><td>${name}</td><td class="qty-highlight">${productCounts[name]}</td></tr>`;
            });
    }

    // --- è©³ç´°è¦–çª—é‚è¼¯ ---
    function openDetailModal(index) {
        currentOrder = allOrders[index];
        document.getElementById('detailModal').style.display = 'flex';
        document.getElementById('viewMode').style.display = 'block';
        document.getElementById('editMode').style.display = 'none';

        // å¡«å…¥è³‡æ–™
        document.getElementById('d-name').innerText = currentOrder.name;
        document.getElementById('d-phone').innerText = currentOrder.phone;
        document.getElementById('d-pickup').innerText = currentOrder.pickup;
        document.getElementById('d-status').innerText = currentOrder.status;
        document.getElementById('d-status').style.color = currentOrder.status === "å·²ç¢ºèª" ? "green" : "red";
        document.getElementById('d-price').innerText = "$" + currentOrder.price;
        document.getElementById('d-list').innerHTML = currentOrder.details.replace(/\n/g, '<br>');

        // å¦‚æœå·²ç¢ºèªï¼Œéš±è—ç¢ºèªæŒ‰éˆ• (æˆ–é¡¯ç¤ºå·²ç¢ºèªæ–‡å­—)
        const btnConf = document.getElementById('btnConfirm');
        if (currentOrder.status === "å·²ç¢ºèª") {
            btnConf.style.display = 'none';
        } else {
            btnConf.style.display = 'inline-block';
        }
    }

    function closeDetailModal() {
        document.getElementById('detailModal').style.display = 'none';
    }

    // --- ç¢ºèªè¨‚å–® ---
    function confirmOrder() {
        if (!confirm("ç¢ºå®šè¦å°‡æ­¤è¨‚å–®æ¨™è¨˜ç‚ºã€Œå·²ç¢ºèªã€å—ï¼Ÿ")) return;
        
        const btn = document.getElementById('btnConfirm');
        btn.innerText = "â³ è™•ç†ä¸­...";
        btn.disabled = true;

        // å‘¼å« Apps Script action=confirm
        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `action=confirm&name=${encodeURIComponent(currentOrder.name)}&phone=${encodeURIComponent(currentOrder.phone)}`
        }).then(() => {
            alert("è¨‚å–®å·²ç¢ºèªï¼");
            closeDetailModal();
            fetchData(); // é‡æ–°æ•´ç†è³‡æ–™
        });
    }

    // --- ä¿®æ”¹æ¨¡å¼é‚è¼¯ ---
    function enableEditMode() {
        document.getElementById('viewMode').style.display = 'none';
        document.getElementById('editMode').style.display = 'block';
        
        // 1. åˆå§‹åŒ– editCart (æ ¹æ“šç¾æœ‰ç”¢å“åˆ—è¡¨)
        // ç‚ºäº†è®“åˆªé™¤æ–¹ä¾¿ï¼Œæˆ‘å€‘é¡¯ç¤ºæ‰€æœ‰ç”¢å“ï¼Œä½†æ•¸é‡æ ¹æ“šè¨‚å–®å…§å®¹é å¡«
        editCart = new Array(products.length).fill(0);
        
        // è§£æè¨‚å–®å­—ä¸²å›å¡«æ•¸é‡ "ç”¢å“A x2"
        let lines = currentOrder.details.split('\n');
        lines.forEach(line => {
            let parts = line.split(' x');
            if (parts.length === 2) {
                let pName = parts[0].trim();
                let pQty = parseInt(parts[1]);
                // æ‰¾åˆ°å°æ‡‰çš„ç”¢å“ç´¢å¼•
                let pIndex = products.findIndex(p => p.name === pName);
                if (pIndex !== -1) editCart[pIndex] = pQty;
            }
        });

        renderEditList();
    }

    function renderEditList() {
        const container = document.getElementById('editListContainer');
        container.innerHTML = '';
        let total = 0;

        products.forEach((p, index) => {
            let qty = editCart[index];
            total += qty * p.price;

            // åªé¡¯ç¤ºæœ‰æ•¸é‡çš„ï¼Œæˆ–è€…å…¨éƒ¨é¡¯ç¤ºï¼Ÿéœ€æ±‚èªªã€Œé¡¯ç¤ºå‡ºæ‰€æœ‰ç”¢å“ã€ï¼Œé€™æ¨£æ‰èƒ½æ–°å¢
            let row = document.createElement('div');
            row.className = 'edit-item';
            row.innerHTML = `
                <div class="edit-item-name">${p.name} ($${p.price})</div>
                <div class="edit-controls">
                    <button class="edit-btn" onclick="changeEditQty(${index}, -1)">-</button>
                    <input class="edit-qty" value="${qty}" readonly>
                    <button class="edit-btn" onclick="changeEditQty(${index}, 1)">+</button>
                </div>
            `;
            container.appendChild(row);
        });
        document.getElementById('edit-total-price').innerText = total;
    }

    function changeEditQty(index, delta) {
        let newQty = editCart[index] + delta;
        if (newQty < 0) newQty = 0; // 0 å°±æ˜¯åˆªé™¤/æ²’é»
        editCart[index] = newQty;
        renderEditList(); // é‡æ–°æ¸²æŸ“æ›´æ–°ç¸½åƒ¹å’Œæ•¸å­—
    }

    function cancelEdit() {
        document.getElementById('viewMode').style.display = 'block';
        document.getElementById('editMode').style.display = 'none';
    }

    function saveEditedOrder() {
        // çµ„è£æ–°çš„è¨‚å–®å­—ä¸²
        let newDetails = [];
        let newTotal = 0;
        
        products.forEach((p, index) => {
            let qty = editCart[index];
            if (qty > 0) {
                newDetails.push(`${p.name} x${qty}`);
                newTotal += qty * p.price;
            }
        });

        if (newDetails.length === 0) {
            alert("è¨‚å–®ä¸èƒ½ç‚ºç©ºï¼");
            return;
        }

        const orderString = newDetails.join("\n");
        const btn = document.getElementById('btnSave');
        btn.innerText = "â³ å„²å­˜ä¸­...";
        btn.disabled = true;

        // å‘¼å« Apps Script action=update
        // ä½¿ç”¨ originalName å’Œ originalPhone ä¾†å®šä½åŸè¨‚å–®
        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `action=update&originalName=${encodeURIComponent(currentOrder.name)}&originalPhone=${encodeURIComponent(currentOrder.phone)}&orderDetails=${encodeURIComponent(orderString)}&totalPrice=${newTotal}`
        }).then(() => {
            alert("ä¿®æ”¹æˆåŠŸï¼");
            closeDetailModal();
            fetchData(); // é‡æ–°æ•´ç†
        }).catch(() => {
            alert("ä¿®æ”¹å¤±æ•—");
            btn.disabled = false;
            btn.innerText = "ğŸ’¾ å„²å­˜ä¿®æ”¹";
        });
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.view-section').forEach(view => view.classList.remove('active'));
        document.getElementById('view-' + tabName).classList.add('active');
    }
</script>

</body>
</html>
